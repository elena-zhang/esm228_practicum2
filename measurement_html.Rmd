---
title: "measurement_html"
author: "Sara Orofino"
date: "4/28/2020"
output: html_document
---

```{r libraries, include=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(kableExtra)
library(DeclareDesign)
```


## Theory of Change  
Organization:  American Rivers  
Program Title: American Rivers Fuel Reduction Program  
Region: Sierra Nevada region, specificallly the following four watersheds  
 1. American River Watershed  
 2. Bear River Watershed  
 3. Cosumnes River Watershed  
 4. Yuba River Watershed  

[Insert image of TOC here]  

## Measure Definition

**Measure 1**  

*Measurement goal* :    
*Exact measure to be taken* :    
*Unit of measurement* :    
*Source of data* :    
*Rationale for choice of measure* :    
*Responsibility for data collection* :      
*Frequency of data collection* :  


## Sampling Strategy

**Measure 1 - Implementation of Fuels Reduction Program** 

*Target population*: Private land owners/managers in the study area

*Challenges to representative sampling*: Much of the land in the Sierra Nevada watershed is federally owned not privately owned. Private land owners require permits to implement fuel reduction programs but fuel reduction typically doesn't occur every year and it is unclear if the same land owner would continue to apply for permits in years immediately following implementing a fuel reduction program on their land.  

*Sampling procedure* Random sampling of private land owners in the study area to determine if they are Cal Fire permit holders, stratified by county since some counties account for a higher proportion of land in the study area. Participants can be mapped to their permit applications by phone number.    


### DeclareDesign()

Declare the population  
```{r measure1-population}
# baseline = proportion of land area each county contributes to the total study area
# prop = proportion of homeowners in each strata out of the total population (workaround for strata mean function error - see 'measure1-delcare-estimator' code below)
# owner = 35% of the number of homeowners in the county, since all homeowners may not have large properties where they are participating in fuel management practices


population <- declare_population(
  county = add_level(N=8, # there are 8 counties in the watershed
                     baseline=c(0.36,0.23,0.18,0.5,0.5,0.5,0.5, 0.3), # % coverage of each county in study area
                     prop=c(0.459298084, 0.243157809, 0.141842055, 0.067543836, 
                            0.054035069, 0.028368411, 0.004552455, 0.001202280)), #proportion of homeowners in each county
  owner = add_level(N=c(34000,18000, 10500, 5000, 4000, 2100, 337, 89), # 35% of each county's homeowner population
                    know=draw_binary(baseline))
)

pop <- population()
pop.vector <- c(34000,18000, 10500, 5000, 4000, 2100, 337, 89)

my_estimand <- declare_estimands(mean(know),
                                 label = "Ybar")
```

Reporting and Sampling  
```{r measure1-report-samp}
reporting <- declare_assignment(prob=0.4, #lower probably that any given homeowner would be a burn permit holder
                  assignment_variable = "R")

sampling <- declare_sampling(strata=county,
               strata_n=c(80,80,80,80,80,80,10,10)) # sample size 500
```


Declare estimator to calculate the strata weighed mean of the sample to estimate the population    
```{r measure1-declare-estimator}
# function to estimate the population mean using the strata weighted sample mean  
strata_weighted_mean <- function(data){
  data.frame(  
    estimator_label = "strata_w_mean",
    estimand_label = "Ybar",
    n = nrow(data),
    stringsAsFactors = FALSE,
    
    estimate = data %>% filter(R==1) %>%
      group_by(as.factor(county)) %>% # strata by county
      summarise(mean=mean(know), prop=mean(prop)) %>% #work around for prop column error - see below
      # mutate(prop=pop.vector/sum(pop.vector)) %>% 
      mutate(sub.mean=mean*prop) %>% pull(sub.mean) %>% 
      sum()) 
} 
# note: prop column kept throwning me a length error (wanted length 7 not 8), I changed all the other vectors to be length 8 and couldn't figure out why it was requiring a length 7 when the strata and my pop.vector was set to 8. Patrick helped me with a workaround - the prop=mean(prop) gives the proportion of households in the strata based on the prop column we defined in the population setup code.  
```

Measure 1 diagnostics
```{r measure1-diagnosis, cache=TRUE}

answer <- declare_estimator(
  handler = tidy_estimator(strata_weighted_mean), 
  estimand = my_estimand) 

design <- population + my_estimand + reporting +
          sampling + answer

diagnosis <- diagnose_design(design, sims = 1000)

diagnosis$diagnosands_df[,c(4,5,12,14)] %>%
  kable()

```